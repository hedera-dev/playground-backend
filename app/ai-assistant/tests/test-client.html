<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>AI SDK Chat Test</title>
		<style>
			body {
				font-family: Arial, sans-serif;
				max-width: 800px;
				margin: 0 auto;
				padding: 20px;
			}
			#chat {
				border: 1px solid #ccc;
				height: 400px;
				overflow-y: auto;
				padding: 10px;
				margin: 10px 0;
			}
			#input {
				width: 70%;
				padding: 10px;
			}
			#send {
				padding: 10px 20px;
			}
			.message {
				margin: 10px 0;
				padding: 10px;
				border-radius: 5px;
			}
			.user {
				background-color: #e3f2fd;
				text-align: right;
			}
			.assistant {
				background-color: #f3e5f5;
			}
			.error {
				background-color: #ffebee;
				color: red;
			}
		</style>
	</head>
	<body>
		<h1>üöÄ AI SDK Chat Test</h1>
		<div id="chat"></div>
		<div>
			<input type="text" id="input" placeholder="Type your message..." />
			<button id="send">Send</button>
		</div>
		<div>
			<p>
				<strong>Server:</strong> <span id="status">Disconnected</span>
			</p>
			<p>
				<strong>Conversation ID:</strong>
				<span id="conversationId">None</span>
			</p>
		</div>

		<script>
			const chat = document.getElementById("chat");
			const input = document.getElementById("input");
			const sendBtn = document.getElementById("send");
			const status = document.getElementById("status");
			const conversationIdSpan =
				document.getElementById("conversationId");

			let conversationId = null;

			function addMessage(content, type = "assistant") {
				const div = document.createElement("div");
				div.className = `message ${type}`;
				div.textContent = content;
				chat.appendChild(div);
				chat.scrollTop = chat.scrollHeight;
			}

			async function sendMessage() {
				const message = input.value.trim();
				if (!message) return;

				// Add user message to chat
				addMessage(message, "user");
				input.value = "";
				sendBtn.disabled = true;

				try {
					status.textContent = "Connecting...";

					const response = await fetch(
						"http://localhost:3001/api/chat/stream",
						{
							method: "POST",
							headers: {
								"Content-Type": "application/json",
							},
							body: JSON.stringify({
								message: message,
								...(conversationId && {
									conversationId: conversationId,
								}),
							}),
						}
					);

					if (!response.ok) {
						throw new Error(
							`HTTP error! status: ${response.status}`
						);
					}

					status.textContent = "Streaming...";

					const reader = response.body.getReader();
					const decoder = new TextDecoder();
					let assistantMessage = "";

					while (true) {
						const { done, value } = await reader.read();
						if (done) break;

						const chunk = decoder.decode(value);
						const lines = chunk.split("\n");

						for (const line of lines) {
							if (line.startsWith("data: ")) {
								try {
									const data = JSON.parse(line.slice(6));

									if (data.type === "start") {
										conversationId = data.conversationId;
										conversationIdSpan.textContent =
											conversationId;
									} else if (data.type === "delta") {
										assistantMessage += data.content;
										// Update the last message or create new one
										const messages =
											chat.querySelectorAll(
												".message.assistant"
											);
										const lastMessage =
											messages[messages.length - 1];
										if (
											lastMessage &&
											lastMessage.dataset.streaming
										) {
											lastMessage.textContent =
												assistantMessage;
										} else {
											const div =
												document.createElement("div");
											div.className = "message assistant";
											div.dataset.streaming = "true";
											div.textContent = assistantMessage;
											chat.appendChild(div);
										}
										chat.scrollTop = chat.scrollHeight;
									} else if (data.type === "complete") {
										const messages =
											chat.querySelectorAll(
												".message.assistant"
											);
										const lastMessage =
											messages[messages.length - 1];
										if (lastMessage) {
											delete lastMessage.dataset
												.streaming;
										}
										assistantMessage = "";
										status.textContent = "Connected";
									} else if (data.type === "error") {
										addMessage(
											`Error: ${data.error}`,
											"error"
										);
										status.textContent = "Error";
									}
								} catch (e) {
									console.error("Error parsing SSE data:", e);
								}
							}
						}
					}
				} catch (error) {
					addMessage(`Connection error: ${error.message}`, "error");
					status.textContent = "Error";
				} finally {
					sendBtn.disabled = false;
				}
			}

			sendBtn.addEventListener("click", sendMessage);
			input.addEventListener("keypress", (e) => {
				if (e.key === "Enter") {
					sendMessage();
				}
			});

			// Test server connection
			fetch("http://localhost:3001/api/health")
				.then((response) => response.json())
				.then((data) => {
					status.textContent = "Connected";
					addMessage(
						"üéâ Connected to AI SDK server! Try sending a message.",
						"assistant"
					);
				})
				.catch((error) => {
					status.textContent = "Server not available";
					addMessage(
						"‚ùå Server not available. Make sure the server is running on port 3001.",
						"error"
					);
				});
		</script>
	</body>
</html>
