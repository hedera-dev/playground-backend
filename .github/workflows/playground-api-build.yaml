name: Build Playground API

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Image tag version"
        required: true
        default: "latest"
        type: string
      set_tag:
        description: "Set a new git tag"
        required: false
        default: false
        type: boolean

jobs:
  build_on_main:
    name: Build - ${{ github.event.inputs.version }} - Main
    runs-on: ubuntu-latest
    environment: develop
    permissions:
      contents: "read"
      id-token: "write"
    env:
      DOCKER_IMAGE_PATH: /playground/playground-api
      TEMP_IMAGE_PATH: /tmp/playground-api
    outputs:
      develop_image_tag: ${{ steps.set-tag.outputs.develop_image_tag }}
    steps:
      - name: Configure Google Cloud Auth
        uses: "google-github-actions/auth@v2"
        if: ${{ github.ref == 'refs/heads/master' }}
        with:
          workload_identity_provider: ${{ vars.GCP_PLAYGROUND_WORKLOAD_IDP }}
          service_account: ${{ vars.GCP_GITHUB_ACTIONS_SERVICE_ACCOUNT }}

      - name: "Set up Cloud SDK"
        if: ${{ github.ref == 'refs/heads/master' }}
        uses: "google-github-actions/setup-gcloud@v2"
        with:
          version: ">= 363.0.0"

      - name: Configure Docker to use gcloud as a credential helper
        if: ${{ github.ref == 'refs/heads/master' }}
        run: |
          gcloud auth configure-docker ${{ vars.GCP_ARTIFACT_ID }}

      - name: Pull the develop Docker image
        if: ${{ github.ref == 'refs/heads/master' }}
        run: |
          docker pull ${{vars.GCP_ARTIFACT_REPOSITORY }}${{ env.DOCKER_IMAGE_PATH }}:${{ github.event.inputs.version }}

      - name: Set docker image tag output
        id: set-tag
        run: echo "develop_image_tag=${{ vars.GCP_ARTIFACT_REPOSITORY }}${{ env.DOCKER_IMAGE_PATH }}:${{ github.event.inputs.version }}" >> "$GITHUB_OUTPUT"

      - name: Save Docker image as tar
        if: ${{ github.ref == 'refs/heads/master' }}
        run: |
          docker save -o ${{ env.TEMP_IMAGE_PATH }}_${{ github.event.inputs.version }}.tar ${{ vars.GCP_ARTIFACT_REPOSITORY }}${{ env.DOCKER_IMAGE_PATH }}:${{ github.event.inputs.version }}

      - name: Upload artifact
        if: ${{ github.ref == 'refs/heads/master' }}
        uses: actions/upload-artifact@v4
        with:
          name: ${{ github.event.inputs.version }}
          path: ${{ env.TEMP_IMAGE_PATH }}_${{ github.event.inputs.version }}.tar
          retention-days: 1

  build_and_push:
    name: Build and Push - ${{ github.event.inputs.version }}
    runs-on: ubuntu-latest
    needs: build_on_main
    environment: ${{ github.ref == 'refs/heads/master' && 'production' || 'develop' }}
    env:
      DOCKER_IMAGE_PATH: /playground/playground-api
      TEMP_IMAGE_PATH: /tmp/playground-api
      DOCKERFILE_PATH: ./app/playground-api/.
      GIT_TAG: playground-api-v${{ github.event.inputs.version }}
    permissions:
      contents: "write"
      id-token: "write"

    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        if: ${{ github.ref == 'refs/heads/master' }}
        with:
          name: ${{ github.event.inputs.version }}
          path: /tmp

      - name: Load image
        if: ${{ github.ref == 'refs/heads/master' }}
        run: |
          docker load --input ${{ env.TEMP_IMAGE_PATH }}_${{ github.event.inputs.version }}.tar
          docker image ls -a

      - name: Checkout code
        if: ${{ github.ref != 'refs/heads/master' }}
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: Configure Google Cloud Auth
        uses: "google-github-actions/auth@v2"
        with:
          workload_identity_provider: ${{ vars.GCP_PLAYGROUND_WORKLOAD_IDP }}
          service_account: ${{ vars.GCP_GITHUB_ACTIONS_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: "google-github-actions/setup-gcloud@v2"
        with:
          version: ">= 363.0.0"

      - name: Configure Docker to use gcloud as a credential helper
        run: |
          gcloud auth configure-docker ${{ vars.GCP_ARTIFACT_ID }}

      - name: Build or Tag Docker image
        run: |
          if [ "${{ github.ref }}" == "refs/heads/master" ]; then
            echo "Tagging image: ${{ needs.build_on_main.outputs.develop_image_tag }} - to - ${{ vars.GCP_ARTIFACT_REPOSITORY }}${{ env.DOCKER_IMAGE_PATH }}:${{ github.event.inputs.version }}"
            docker tag ${{ needs.build_on_main.outputs.develop_image_tag }} ${{ vars.GCP_ARTIFACT_REPOSITORY }}${{ env.DOCKER_IMAGE_PATH }}:${{ github.event.inputs.version }}
          else
            echo "Building image for develop branch"
            docker build --platform linux/amd64 -t ${{ vars.GCP_ARTIFACT_REPOSITORY }}${{ env.DOCKER_IMAGE_PATH }}:${{ github.event.inputs.version }} ${{ env.DOCKERFILE_PATH}}
          fi

      - name: Push Docker image to Google Artifact Registry
        run: |
          docker push ${{ vars.GCP_ARTIFACT_REPOSITORY }}${{ env.DOCKER_IMAGE_PATH }}:${{ github.event.inputs.version }}

      - name: Create and push a new git tag
        if: ${{ github.event.inputs.set_tag == 'true' && github.event.inputs.version != 'latest' && github.ref != 'refs/heads/master' }}
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git fetch --all
          git checkout ${{ github.ref }}
          git tag -a "${{ env.GIT_TAG }}" -m "Version ${{ github.event.inputs.version }}"
          git push origin "${{ env.GIT_TAG }}"

      - name: Display success
        run: |
          echo "Successfully pushed: ${{ vars.GCP_ARTIFACT_REPOSITORY }}${{ env.DOCKER_IMAGE_PATH }}:${{ github.event.inputs.version }}"
